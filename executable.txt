# ==============================================================================
# SCRIPT UNIVERSAL DE MIGRACI√ìN A SUBM√ìDULOS CON C√ÅPSULA DEL TIEMPO
# Autor: Gemini (Asistente de IA)
# ==============================================================================

# 1. CONFIGURACI√ìN INICIAL
$repoRoot = Get-Location
$fecha = Get-Date -Format 'yyyy-MM-dd_HHmm'
$desktopPath = [Environment]::GetFolderPath("Desktop")
$rutaCapsula = Join-Path $desktopPath "BACKUP_REPOS_$fecha"

Clear-Host
Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
Write-Host "‚ïë   MIGRACI√ìN INTELIGENTE DE REPOSITORIOS ANIDADOS A SUBM√ìDULOS  ‚ïë" -ForegroundColor Cyan
Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Cyan
Write-Host "`nüìÅ Directorio de trabajo: $repoRoot"
Write-Host "üì¶ La C√°psula del Tiempo (Backup) estar√° en: $rutaCapsula" -ForegroundColor Yellow

# 2. ESCANEO AUTOM√ÅTICO
Write-Host "`nüîç Escaneando carpetas en busca de repositorios anidados..." -ForegroundColor Cyan

# Buscamos carpetas .git, excluyendo la del propio directorio ra√≠z y los que ya est√°n dentro de .git/modules
$carpetasGit = Get-ChildItem -Path $repoRoot -Recurse -Directory -Filter ".git" | 
    Where-Object { 
        $_.Parent.FullName -ne $repoRoot.Path -and 
        $_.FullName -notlike "*\.git\modules\*" -and
        $_.FullName -notlike "*node_modules*" 
    }

if ($carpetasGit.Count -eq 0) {
    Write-Host "‚úÖ No se encontraron repositorios anidados conflictivos." -ForegroundColor Green
    exit
}

Write-Host "‚ö†Ô∏è  Se han detectado $($carpetasGit.Count) repositorios anidados." -ForegroundColor Magenta
Write-Host "   El script intentar√° extraer la URL remota de cada uno autom√°ticamente.`n"

# Pausa de seguridad
Read-Host "Presiona ENTER para comenzar el proceso (Ctrl+C para cancelar)"

# Crear carpeta de backup
New-Item -ItemType Directory -Force -Path $rutaCapsula | Out-Null

# 3. PROCESAMIENTO
foreach ($gitFolder in $carpetasGit) {
    $carpetaProyecto = $gitFolder.Parent
    $rutaRelativa = $carpetaProyecto.FullName.Substring($repoRoot.Path.Length + 1)
    $rutaBackup = Join-Path $rutaCapsula $rutaRelativa
    
    Write-Host "------------------------------------------------------------"
    Write-Host "Procesando: $rutaRelativa" -ForegroundColor Cyan

    # A. DETECTAR URL (Antes de mover nada)
    $url = git -C $carpetaProyecto.FullName remote get-url origin 2>$null

    if (-not $url) {
        Write-Host "‚ùå ERROR: No se detect√≥ URL remota (origin) en esta carpeta." -ForegroundColor Red
        Write-Host "   Saltando para evitar p√©rdida de datos..." -ForegroundColor Gray
        continue
    }
    Write-Host "   üîó URL detectada: $url" -ForegroundColor Gray

    # B. DESVINCULAR DEL PADRE
    git rm --cached -r "$rutaRelativa" 2>$null

    # C. MOVER A C√ÅPSULA DEL TIEMPO
    # Crear estructura de carpetas en backup
    $parentBackup = Split-Path $rutaBackup -Parent
    if (-not (Test-Path $parentBackup)) { New-Item -ItemType Directory -Force -Path $parentBackup | Out-Null }
    
    try {
        Move-Item -Path $carpetaProyecto.FullName -Destination $rutaBackup -Force -ErrorAction Stop
        Write-Host "   üì¶ MOVIDO a backup de seguridad." -ForegroundColor Green
    }
    catch {
        Write-Host "   üõë ERROR al mover la carpeta. ¬øQuiz√°s est√° en uso?" -ForegroundColor Red
        continue
    }

    # D. A√ëADIR COMO SUBM√ìDULO
    Write-Host "   ‚¨áÔ∏è  Descargando subm√≥dulo limpio..." -ForegroundColor Yellow
    git submodule add $url "$rutaRelativa"

    if ($LASTEXITCODE -ne 0) {
        Write-Host "   ‚ùå Fall√≥ la descarga de git. Restaurando desde backup..." -ForegroundColor Red
        Move-Item -Path $rutaBackup -Destination $carpetaProyecto.FullName -Force
        continue
    }

    # E. RESTAURACI√ìN INTELIGENTE (.env y archivos ocultos)
    # Busca recursivamente archivos .env en el backup de este proyecto
    $archivosEnv = Get-ChildItem -Path $rutaBackup -Recurse -Filter ".env"
    
    if ($archivosEnv) {
        foreach ($env in $archivosEnv) {
            # Calcular d√≥nde debe ir en la nueva estructura
            $subPath = $env.FullName.Substring($rutaBackup.Length)
            $destinoEnv = "$($carpetaProyecto.FullName)$subPath"
            
            Copy-Item -Path $env.FullName -Destination $destinoEnv -Force
            Write-Host "   üíé .env RESTAURADO: $subPath" -ForegroundColor Magenta
        }
    }

    # F. FIX PARA CARPETAS VAC√çAS (Caso de estructuras redundantes)
    # Si la carpeta reci√©n creada est√° vac√≠a (salvo .git), forzamos update
    $contenido = Get-ChildItem -Path $carpetaProyecto.FullName
    if ($contenido.Count -le 1) {
        Write-Host "   üîß La carpeta parece vac√≠a. Forzando checkout..." -ForegroundColor Yellow
        git submodule update --init --recursive "$rutaRelativa"
    }
}

# 4. RESUMEN FINAL
Write-Host "`n============================================================"
Write-Host "‚úÖ PROCESO FINALIZADO" -ForegroundColor Green
Write-Host "============================================================"
Write-Host "1. Tus carpetas antiguas est√°n en el ESCRITORIO: $rutaCapsula"
Write-Host "2. Tu repositorio ahora usa Subm√≥dulos oficiales."
Write-Host "3. Revisa si falta alg√∫n archivo espec√≠fico (PDFs, im√°genes grandes) en el backup."

Write-Host "`nPara guardar los cambios en la nube, ejecuta:" -ForegroundColor Cyan
Write-Host "   git add ."
Write-Host "   git commit -m 'Refactorizaci√≥n autom√°tica a Subm√≥dulos'"
Write-Host "   git push"